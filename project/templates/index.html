<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CS 527 Project</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    <script>
        function queryExecution(){
            let query = document.getElementById('query').value;     // input query
            if(query.length == 0){
                alert("Empty Query!");
                return;
            }

            let databaseTypes = document.getElementsByName('database');     // databases list
            let databaseType;   //mysql or redshift or mongodb
            for (let i = 0; i < databaseTypes.length; i++) {
                if(databaseTypes[i].checked){
                    databaseType = databaseTypes[i].value
                    break;
                }
            }
            if(!databaseType){
                alert("You haven't connected to a database!\nPlease choose a database first!");
                return;
            }
            let currentDatabaseName = document.getElementById('current-database');      // selected database/schema

            $.ajax(
                {
                    url:'query_submit/',
                    type: 'POST',
                    data: {'databaseType': databaseType, 'query': query, 'currentDatabase': currentDatabaseName.innerText},
                    success: function(arg){
                        if(arg['responseStatus']){
                            alert(arg['errorDetails'])
                        }
                        else{
                            let influencedRowResult = arg['influencedRowResult'];
                            let resultAttribute = arg['resultAttribute'];
                            let queryResult = arg['queryResult'];
                            let executionTime = arg['executionTime'];
                            let currentDatabase = arg['currentDatabase'] === "None" ? '' : arg['currentDatabase'];
                            // document.getElementById('result-area').value = arg['queryResult'];
                            document.getElementById('result-area').value = formatOutput(influencedRowResult, resultAttribute, queryResult);
                            document.getElementById('execution-time').innerText = executionTime;
                            currentDatabaseName.innerText = currentDatabase;
                        }
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        alert("Status: " + textStatus + "\nError: " + errorThrown)
                    }
                });
        }
        function switchDatabase(){
            let databaseTypes = document.getElementsByName('database');     // databases list
            let databaseType;   //mysql or redshift or mongodb
            for (let i = 0; i < databaseTypes.length; i++) {
                if(databaseTypes[i].checked){
                    databaseType = databaseTypes[i].value
                    break;
                }
            }
            let currentDatabaseName = document.getElementById('current-database');
            $.ajax(
                {
                    url:'switch_database/',
                    type: 'POST',
                    data: {'databaseType': databaseType},
                    success: function(arg){
                        if(arg['responseStatus'] === 1){
                            alert(arg['errorDetails'])
                            for (let i = 0; i < databaseTypes.length; i++) {
                                if(databaseTypes[i].checked){
                                    databaseTypes[i].checked = false
                                    break;
                                }
                            }
                        }
                        else{
                            alert('Switch to ' + databaseType + ' successfully!')
                            currentDatabaseName.innerText = arg['currentDatabase']
                        }
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        alert("Status: " + textStatus + "\nError: " + errorThrown + '\nFailed to connect to ' + databaseType + '. Please try again.')
                        for (let i = 0; i < databaseTypes.length; i++) {
                            if(databaseTypes[i].checked){
                                databaseTypes[i].checked = false
                                break;
                            }
                        }
                    }
                });
        }
        function formatOutput(influencedRowResult, resultAttribute, queryResult){
            let formatResult = "";
            for(let i = 0; i < influencedRowResult.length; i++){
                formatResult += influencedRowResult[i] + "\n"
                for(let column in resultAttribute[i]){
                    formatResult += resultAttribute[i][column] + "\t"
                }
                formatResult += "\n"
                for(let row in queryResult[i]){
                    for(let column in queryResult[i][row]){
                        formatResult += queryResult[i][row][column] + "\t"
                    }
                    formatResult += "\n"
                }
                formatResult += "\n"
            }
            return formatResult
        }
    </script>
</head>
<body style="font-family: 'Cascadia Mono', serif;">
<div style="margin: auto; width: fit-content">
    <form action="" method="post">
        <div id="database-div">
            <p style="display: inline-block; margin: 0">Database:</p>
            <div style="display: inline-block; border: 1px solid">
                <p id="current-database" style="display: inline-block; margin: 0;"></p>
            </div>
            <label style="margin-left: 10%">
                <input type="radio" name="database" value="mysql" onclick="switchDatabase()">MySQL
                <input type="radio" name="database" value="redshift" style="margin-left: 10%" onclick="switchDatabase()">Redshift
            </label>
        </div>
        <div id="query-div" style="margin-top: 10px">
            <p style="margin: 0">Query:</p>
            <label for="query"></label><textarea id="query" name="query" cols="45" rows="15" style="resize: none; margin-top: 5px; font-family: 'Cascadia Mono', serif; font-size: 14pt" spellcheck="false"></textarea>
        </div>
        <div id="run-button-div" style="margin-top: 1px">
            <button type="button" onclick="queryExecution()" style="display: inline-block; background: rgb(192, 255, 192); width: 30%; font-family: 'Cascadia Mono', serif;" accesskey="s">Run</button>
            <div style="float: right; display: inline-block">
                <p style="display: inline-block; margin: 0">Time Elapsed: </p>
                <p id="execution-time" style="display: inline-block; margin: 0">0.0 s</p>
            </div>
        </div>
        <div id="result-div" style="margin-top: 5px">
            <textarea id="result-area" name="result" cols="70" rows="10" style="resize: none; background: rgb(171, 171, 171)" readonly spellcheck="false"></textarea>
        </div>
    </form>
</div>

</body>
</html>